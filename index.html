<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART-RDS Government Portal</title>

    <!-- Firebase compat SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif}
        body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
        .container{max-width:1200px;margin:0 auto;background:white;border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,0.1)}
        h1{text-align:center;color:#1a1a1a;margin-bottom:30px;font-size:2.2em}
        .section{margin-bottom:40px;padding:25px;border-radius:15px;background:#f8f9ff;box-shadow:0 5px 15px rgba(0,0,0,0.08)}
        .section h2{margin-bottom:20px;color:#333;font-size:1.5em}
        .card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:20px}
        .item-card{background:#fff;border:2px solid #e1e5e9;border-radius:12px;padding:20px;text-align:center;transition:all 0.3s}
        .item-card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,0.1)}
        .item-name{font-weight:bold;font-size:1.1em;color:#2c3e50;margin-bottom:10px}
        input[type=number]{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px;text-align:center}
        input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}
        .btn{width:100%;padding:15px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;transition:all 0.3s}
        .btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(102,126,234,0.3)}
        .btn.small{width:auto;padding:10px 18px;margin-top:10px}
        .status{display:none;padding:15px;margin:20px 0;border-radius:10px;font-weight:bold;text-align:center}
        .status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
        .status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
        table{width:100%;border-collapse:collapse;margin-top:20px}
        th,td{padding:12px;text-align:left;border-bottom:1px solid #eee}
        th{background:#667eea;color:white;font-weight:600}
        .card-tabs{display:flex;gap:10px;margin-bottom:20px}
        .tab-btn{padding:12px 24px;border:none;border-radius:25px;background:#e1e5e9;color:#666;cursor:pointer;transition:all 0.3s}
        .tab-btn.active{background:#667eea;color:white}
        @media(max-width:768px){.card-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="container">
        <h1>üáÆüá≥ SMART-RDS Government Portal</h1>

        <!-- Shop selector -->
        <div class="section">
            <h2>üè¨ Select Ration Shop</h2>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                <label style="font-weight:bold">Shop ID:</label>
                <input type="text" id="shopIdInput" value="TN001"
                       style="padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:16px;min-width:150px">
                <button class="btn small" onclick="applyShopId()">‚úÖ Apply</button>
            </div>
            <p id="shopInfo" style="margin-top:8px;color:#555;font-size:14px">
                Current shop: <b>TN001</b>
            </p>
        </div>

        <!-- Total stock per item -->
        <div class="section">
            <h2>üèõÔ∏è Total Stock for Shop <span id="shopTitle">TN001</span></h2>
            <div class="card-grid" id="totalStockGrid">
                <!-- Filled by JS -->
            </div>
            <button class="btn" onclick="saveTotalStock()">üíæ Save Total Stock to Shop</button>
        </div>
        
        <!-- Allocation Section -->
        <div class="section">
            <h2>üìä Set Item Allocations per Card Type</h2>
            <div class="card-tabs">
                <button class="tab-btn active" onclick="switchTab('AAY')">AAY</button>
                <button class="tab-btn" onclick="switchTab('NPHH')">NPHH</button>
                <button class="tab-btn" onclick="switchTab('PHH')">PHH</button>
            </div>
            <div class="card-grid" id="allocationGrid">
                <!-- Items populated by JS -->
            </div>
            <button class="btn" onclick="saveAllocations()">üíæ Save Allocations to Shops</button>
            <div id="statusMsg" class="status"></div>
        </div>

        <!-- Weekly Stock Report -->
        <div class="section">
            <h2>üìà Weekly Stock Report (<span id="shopTitleReport">TN001</span>)</h2>
            <div id="stockTable"></div>
            <button class="btn small" onclick="loadStockReport()">üîÑ Refresh Report</button>
        </div>
    </div>

<script>
    // Firebase config (your values)
    const firebaseConfig = {
      apiKey: "AIzaSyCf5yQAkQGICClkV1p39p8dqNIiZQoKeKc",
      authDomain: "smart-rds.firebaseapp.com",
      databaseURL: "https://smart-rds-default-rtdb.firebaseio.com",
      projectId: "smart-rds",
      storageBucket: "smart-rds.firebasestorage.app",
      messagingSenderId: "1059807897058",
      appId: "1:1059807897058:web:46fa1720cb7ca87658c5bb",
      measurementId: "G-BFE86XW3DF"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const ITEMS = ['rice', 'sugar', 'wheat', 'dhal', 'kerosene'];
    let currentCardType = 'AAY';
    let currentShopId = 'TN001';

    window.onload = function() {
        createTotalStockGrid();
        createAllocationGrid();
        loadAllForShop();
        setInterval(loadStockReport, 30000);
    };

    function unitLabel(item, perCard) {
        if (item === 'kerosene') return perCard ? 'Per card L' : 'Total L';
        return perCard ? 'Per card kg' : 'Total kg';
    }

    function applyShopId() {
        const id = document.getElementById('shopIdInput').value.trim();
        if (!id) return;
        currentShopId = id;
        document.getElementById('shopTitle').textContent = currentShopId;
        document.getElementById('shopTitleReport').textContent = currentShopId;
        document.getElementById('shopInfo').innerHTML =
            'Current shop: <b>' + currentShopId + '</b>';
        loadAllForShop();
    }

    function loadAllForShop() {
        loadTotalStock();
        loadCurrentValues();
        loadStockReport();
    }

    /* ---------- TOTAL STOCK (GOVT ‚Üí SHOP) ---------- */

    function createTotalStockGrid() {
        const grid = document.getElementById('totalStockGrid');
        grid.innerHTML = '';
        ITEMS.forEach(item => {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `
                <div class="item-name">${item.toUpperCase()} (${unitLabel(item,false)})</div>
                <input type="number" id="total_${item}" min="0" step="0.1" placeholder="">
            `;
            grid.appendChild(card);
        });
    }

    async function loadTotalStock() {
        try {
            const snap = await db.ref('shops/' + currentShopId + '/stockTotals').once('value');
            ITEMS.forEach(item => {
                const el = document.getElementById('total_' + item);
                if (!el) return;
                if (snap.exists() && snap.val()[item] !== undefined) {
                    el.value = snap.val()[item];
                } else {
                    el.value = '';   // no default 0.1
                }
            });
        } catch (e) { console.error(e); }
    }

    async function saveTotalStock() {
        const totals = {};
        ITEMS.forEach(item => {
            const input = document.getElementById('total_' + item);
            const v = input.value.trim();
            totals[item] = v === '' ? 0 : parseFloat(v);
        });

        try {
            await db.ref('shops/' + currentShopId + '/stockTotals').set(totals);
            showStatus('‚úÖ Total stock saved for shop ' + currentShopId, 'success');
            loadStockReport();
        } catch (e) {
            console.error(e);
            showStatus('‚ùå Error saving total stock', 'error');
        }
    }

    /* ---------- PER CARD TYPE ALLOCATION ---------- */

    function switchTab(type) {
        currentCardType = type;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        createAllocationGrid();
        loadCurrentValues();
    }

    function createAllocationGrid() {
        const grid = document.getElementById('allocationGrid');
        grid.innerHTML = '';
        ITEMS.forEach(item => {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `
                <div class="item-name">${item.toUpperCase()} (${unitLabel(item,true)})</div>
                <input type="number" id="${item}_${currentCardType}" min="0" step="0.1" placeholder="">
            `;
            grid.appendChild(card);
        });
    }

    async function loadCurrentValues() {
        try {
            const snapshot = await db.ref('shops/' + currentShopId + '/allocations/' + currentCardType).once('value');
            ITEMS.forEach(item => {
                const el = document.getElementById(item + '_' + currentCardType);
                if (!el) return;
                if (snapshot.exists() && snapshot.val()[item] !== undefined) {
                    el.value = snapshot.val()[item];
                } else {
                    el.value = '';   // empty when no data yet
                }
            });
        } catch(e) { console.error(e); }
    }

    async function saveAllocations() {
        const allocations = {};
        ITEMS.forEach(item => {
            const input = document.getElementById(item + '_' + currentCardType);
            const v = input.value.trim();
            allocations[item] = v === '' ? 0 : parseFloat(v);
        });

        try {
            await db.ref('shops/' + currentShopId + '/allocations/' + currentCardType).set(allocations);
            showStatus('‚úÖ Allocations saved for ' + currentCardType +
                       ' in shop ' + currentShopId, 'success');
            loadStockReport();
        } catch(e) {
            console.error(e);
            showStatus('‚ùå Error saving allocations', 'error');
        }
    }

    function showStatus(msg, type) {
        const status = document.getElementById('statusMsg');
        status.textContent = msg;
        status.className = 'status ' + type;
        status.style.display = 'block';
        setTimeout(() => status.style.display = 'none', 5000);
    }

    /* ---------- WEEKLY REPORT VIEW ---------- */

    async function loadStockReport() {
        try {
            const [totalSnap, soldSnap, allocSnap] = await Promise.all([
                db.ref('shops/' + currentShopId + '/stockTotals').once('value'),
                db.ref('shops/' + currentShopId + '/stock').once('value'),
                db.ref('shops/' + currentShopId + '/allocations/AAY').once('value')
            ]);

            const totals = totalSnap.exists() ? totalSnap.val() : {};
            const stock  = soldSnap.exists()  ? soldSnap.val()  : {};
            const allocAAY = allocSnap.exists() ? allocSnap.val() : {};

            const table = document.getElementById('stockTable');
            let html = `
                <table>
                    <tr>
                      <th>Item</th>
                      <th>Total Stock (Govt ‚Üí Shop)</th>
                      <th>Sold This Week</th>
                      <th>Remaining</th>
                      <th>AAY Per Card Limit</th>
                    </tr>
            `;

            ITEMS.forEach(item => {
                const unit = item === 'kerosene' ? 'L' : 'kg';
                const total = totals[item] || 0;
                const sold  = stock[item]?.sold || 0;
                const remaining = total - sold;
                const limitAAY = allocAAY[item] || 0;

                html += `<tr>
                    <td>${item.toUpperCase()}</td>
                    <td>${total} ${unit}</td>
                    <td>${sold} ${unit}</td>
                    <td style="color:${remaining<0?'red':'green'}">${remaining} ${unit}</td>
                    <td>${limitAAY} ${unit}</td>
                </tr>`;
            });

            html += '</table>';
            table.innerHTML = html;
        } catch(e) { console.error(e); }
    }
</script>
</body>
</html>
